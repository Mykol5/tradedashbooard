(function($){var limit=1048576*16;var uploadedFirstSide=0,uploadedOtherSide=0,showOtherSide=false,refreshIntervalId=0,fileUploaded=false;$('.datepicker').datepicker({format:'yyyy-mm-dd'});if($('#documents-form').hasClass('locked')){lockForm($('#documents-form'));}
function lockForm(form){form.find('input, textarea').not(':disabled').attr('disabled',1).data('locked',true);form.find('select').not(':disabled').attr('disabled',1).data('locked',true).each(function(){var dropdown=$(this).data('dropdown');if(dropdown){dropdown.disable();}});form.find('span.button-normal').hide();form.find(':submit').hide();}
var disabledTitle=$('#submit_btn')?$('#submit_btn').prop('title'):'';var clone={};function bytesToSize(bytes){let sizes=['Bytes','KB','MB','GB','TB'];if(bytes===0){return'0 MB';}
let i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)),10);if(i===0){return`${bytes}${sizes[i]}`;}
return`${(bytes/(1024**i)).toFixed(1)}${sizes[i]}`}
function hideCanvas(element){$(element).removeClass('d-flex').addClass('d-none');}
function updateThumbnail(dropZoneElement,file){let thumbnailElement=dropZoneElement.querySelector(".drop-zone_thumb");$(dropZoneElement).find(".drop-zone_prompt").hide();if(file.type.startsWith('image/')){$(dropZoneElement).find(".drop-zone_thumb").show();$(dropZoneElement).find(".drop-zone_pdf").switchClass('d-flex','d-none');const reader=new FileReader();reader.readAsDataURL(file);reader.onload=()=>{$(thumbnailElement).attr('src',URL.createObjectURL(file));};}else if(file.type=='application/pdf'){$(dropZoneElement).find(".drop-zone_thumb").hide();$(dropZoneElement).find(".drop-zone_pdf").removeClass('d-none').addClass('d-flex');}else{$(dropZoneElement).find(".drop-zone_thumb").show();hideCanvas($(dropZoneElement).find(".drop-zone_pdf"));$(thumbnailElement).attr('src','');}}
function processPDF(loadingTask,canvas){loadingTask.promise.then(function(pdf){var pageNumber=1;pdf.getPage(pageNumber).then(function(page){var scale=1;var viewport=page.getViewport({scale:scale});var context=canvas.getContext('2d');canvas.height=viewport.height;canvas.width=viewport.width;var renderContext={canvasContext:context,viewport:viewport};var renderTask=page.render(renderContext);renderTask.promise.then(function(){$(canvas).parent().parent().find('.spinner-loader').removeClass('d-flex').addClass('d-none');$(canvas).parent().parent().find(".drop-zone_thumb").hide();$(canvas).removeClass('d-none').addClass('d-flex');$(canvas).parent().removeClass('d-none').addClass('d-flex');});});},function(reason){console.error(reason);});}
function setThumbPDF(url,canvas){$(canvas).parent().parent().find('.spinner-loader').removeClass('d-flex').addClass('d-none');$(canvas).parent().parent().find(".drop-zone_thumb").hide();$(canvas).removeClass('d-none').addClass('d-flex');$(canvas).parent().removeClass('d-none').addClass('d-flex');}
function setThumbImage(url,element){$(element).attr('src',url).show();}
function clearFiles(fileInput=undefined){clone={};if(fileInput!==undefined){fileInput.attr('value','');fileInput.parent().parent().find('.drop-zone_thumb').attr('src','').hide();fileInput.parent().parent().find('.drop-zone_pdf').attr('src','').hide();fileInput.parent().parent().find('.drop-zone_prompt').show();}else{$('#file-first, #file-other').attr('value','');$('.drop-zone_thumb').attr('src','').hide();$(".drop-zone_pdf").each(function(index,val){hideCanvas(val);});$("#progress-bar").attr("aria-valuenow",0).attr("style","width:0%");uploadedFirstSide=uploadedOtherSide=0;$('#fileSize').html(bytesToSize(0));$('#progressError').hide();}}
function updateThumb(fileData,side){if(fileData[side]!=undefined&&fileData[side]['id']!=undefined&&fileData[side]['mime_type']!=undefined){let id=fileData[side]['id'];if(fileData[side]['mime_type']=='application/pdf'){setThumbPDF("/files/images?id="+id,$('#dropZone-'+side).find(".pdf-preview")[0])}else{setThumbImage("/files/images?id="+id,$('#dropZone-'+side).find(".drop-zone_thumb")[0]);}}}
function checkFileExtension(element){var fileExtension=['jpeg','jpg','png','gif','pdf'];if($.inArray(element.val().split('.').pop().toLowerCase(),fileExtension)==-1){$('#extensionError').show();clearFiles(element);return false;}
$('#extensionError').hide();return true;}
function disableSubmitButton(disable=false){if(allowEditPoa&&showAddressFields){$('.address-data .form-control').each(function(){if($(this).val()===''&&$(this).attr('name')!=='address2'){disable=true;return 1;}});}
if(allowEditPoi&&showIdentityFields){$('.identity-data .form-control').each(function(){if(($(this).val()===''&&$(this).attr('name')!=='expiry_date')||$(this).hasClass('is-invalid')){disable=true;return 1;}});}
if(disable){if(!$('#submit_btn').hasClass('disabled')){$('#submit_btn').addClass('disabled').attr('disabled',true);}}else{$('#submit_btn').removeClass('disabled').removeAttr('disabled');}
$('#submit_btn').prop('title',$('#submit_btn').hasClass('disabled')?disabledTitle:'');}
function fileChanged(e){var fileElement=e.target;var size=0;if((fileElement.value=="")&&(clone[fileElement.id]!=undefined)){let elem=$(fileElement).parent().find('.drop-zone_prompt'),id='#'+fileElement.id;$(fileElement).remove();clone[fileElement.id].insertAfter(elem);clone[fileElement.id]=undefined;let file=$(id)[0]!==undefined?$(id)[0].files[0]:null;if(null!==file&&file.type=='application/pdf'){$(id).parent().find(".drop-zone_thumb").hide();$(id).parent().find(".drop-zone_pdf").removeClass('d-none').addClass('d-flex');}
setFileEvents($(id));return;}
if((fileElement.files.length&&!checkFileExtension($(fileElement)))||!fileElement.files.length){$(fileElement).attr('src','');$(fileElement).parent().find('.drop-zone_thumb').attr('src','').hide();hideCanvas($(fileElement).parent().find('.drop-zone_pdf'));$(fileElement).parent().find('.drop-zone_prompt').show();}else{updateThumbnail($(fileElement).parent()[0],fileElement.files[0]);size=fileElement.files[0].size;$(this).removeClass("is-invalid");}
if($(fileElement).attr('id')==='file-first'){uploadedFirstSide=size;}
if($(fileElement).attr('id')==='file-other'){uploadedOtherSide=size;}
let uploaded=uploadedFirstSide+uploadedOtherSide,new_size=uploaded/limit*100;$('#progress-bar').attr("aria-valuenow",new_size).attr('style','width:'+new_size+'%');$('#fileSize').html(bytesToSize(uploaded));let disable=false;if((limit>=uploaded&&size!==0)&&(showOtherSide&&(uploadedFirstSide>0)&&(uploadedOtherSide>0)||!showOtherSide&&uploadedFirstSide!==0)){disable=$('select#type').val()==='';$('#progress-bar').removeClass('red').addClass('bg-success');$('#progressError').hide();}else if(limit<uploaded){disable=true;$('#submit_btn').addClass('disabled').attr('disabled',true);$('#progress-bar').addClass('red').removeClass('bg-success');$('#progressError').show();}else{disable=true;$('#submit_btn').addClass('disabled').attr('disabled',true);$('#progress-bar').removeClass('red').addClass('bg-success');$('#progressError').hide();}
filesIsValid=!disable;disableSubmitButton(disable);}
function setFileEvents(element){element.on('change',function(event){fileUploaded=true;fileChanged(event);});}
function setTypes(step,poiType=false){let types=step==='POI'?poiTypes:poaTypes;let documents='',utilityId=125,documentNames=[];if(step==='POI'){$('.guide-poi').show();$('.guide-por').hide();}else{$('.guide-por').show();$('.guide-poi').hide();}
$("#type option").each(function(i){if(i!==0){(this).remove();}});$.each(types,function(i,value){if(!(allowEditPoa&&(value===poiType))){if(i!==0&&step==='POI'){documents+=' '+conjunction+' ';}
$('#type').append($('<option>',{value:value,text:documentTypes[value]}));if(step==='POI'){documents+=documentTypes[value];}else if(value!==utilityId){documentNames.push(documentTypes[value].toLowerCase());}}});documents=step==='POI'?documents:documentNames.join(', ')+'.';$('#type').removeAttr('disabled');$('.documents_part').html(' '+documents+' ');}
function setRejectionReasons(codes,step){if(codes!==undefined){let reasons='';codes.forEach(function(val){if(rejectedStatuses[val]!=undefined){reasons+='<li>'+rejectedStatuses[val]+'</li>';}});if(reasons===''){reasons='<li>'+rejectedStatuses['INVALID']+'</li>';}
$('#upload_'+step.toLowerCase()+'_status_rejected').find('.rejected-reasons').each(function(){$(this).html(reasons);});}}
function update(id,checkOnlyCrm=false){let url='/json/document-status.json?step='+$('[name=step]').val()+'&id='+id;if(checkOnlyCrm){url+='&crm=1';}
$.getJSON(url,function(json){if(json&&json.error){clearInterval(refreshIntervalId);}
if(json&&json.success){if(json.step==='done'){window.location.href=overviewTemplate;}else{clearInterval(refreshIntervalId);if(json.documentPOR!==undefined){updateDataForPOR(json.documentPOR);}else{allowEditPoa=json.step==='POR'&&!json.manual;allowEditPoi=json.step==='POI'&&!json.manual;status=json.status;let codes=json.codes.split(",");if(json.reset){updateStatus=true;changeData(json.data,json.step,codes);}else{changeData(json.data,json.step,codes,false,json.manual,!json.crm&&!json.manual);}
if(status==='rejected'&&!json.reset&&!json.crm){refreshIntervalId=setInterval(update,10000,json.fileId,true);}else{refreshIntervalId=setInterval(update,10000,'all');}}}}});}
function changeData(files,step,codes=[],firstLoad=false,manual=false,reload=true){if(reload){let poiType=files&&files['POI']&&files['POI']['type']?parseInt(files['POI']['type']):null;setTypes(step,poiType);}
if(step==='done'){$('.alert.kyc.d-block').removeClass('d-block').addClass('d-none');if(!$('.stepper-item.poa').hasClass('completed')){$('.stepper-item.poa').removeClass('active').addClass('completed');$('.icon-clock.yellow').removeClass('icon-clock yellow').addClass('icon-tick green');}else{$('.icon-clock.yellow').removeClass('icon-clock yellow');}
$('#documents-form').remove();$('.card.profile').show();$('.guid').hide();$('#verification_done').removeClass('d-none').addClass('d-block');$('.popover-username').attr('data-content',documents_uploaded);$('.popover-username span').removeClass('icon-note kyc-status red').addClass('icon-done green');return;}
if((step==='POI'&&!allowEditPoi)||(step==='POR'&&!allowEditPoa)){if(manual){$('.alert.kyc.d-block').removeClass('d-block').addClass('d-none');setRejectionReasons(codes,step);if(!$('#manual_approval_in_progress').hasClass('d-block')){$('#manual_approval_in_progress').removeClass('d-none').addClass('d-block');}}
if(reload||!manual){$('#type').val(files[step]['type']).attr('disabled',true).change();if(files[step]!=undefined){$('.spinner-loader').removeClass('d-none').addClass('d-flex');let fileData=files[step];updateThumb(fileData,'front');updateThumb(fileData,'back');$('.drop-zone_prompt, .card-footer, .documents-info').hide();$('.drop-zone').addClass('preview');$('.card.profile').hide();}
if(step==='POR'&&showAddressFields){$('.address-heading').removeClass('hide');}}
if(step==='POI'&&showIdentityFields){$('.identity-heading').removeClass('hide');$(".datepicker").prop("disabled","disabled");}
return;}
if((allowEditPoi||allowEditPoa)&&updateStatus){$('.popover-username').attr('data-content',allowEditPoi?poi_not_uploaded:poa_not_uploaded);if(status==='rejected'&&(!firstLoad||(status==='rejected'&&$('#upload_'+step.toLowerCase()+'_status_rejected').find('.rejected-reasons li').length===0))){setRejectionReasons(codes,step);$('.icon-clock.yellow').remove();}
if(!firstLoad){$('.alert.kyc.d-block').removeClass('d-block').addClass('d-none');if(!manual){$('#upload_'+(allowEditPoa&&status==='approved'?'poi':step.toLowerCase())+'_status_'+status).removeClass('d-none').addClass('d-block');}}
if(reload){$('.card-footer, .documents-info').show();$('.drop-zone').removeClass('preview');$('.spinner-loader').removeClass('d-flex').addClass('d-none');$('#type').val(null).attr('disabled',false).change();}
if(manual==true&&!$('#manual_approval_in_progress').hasClass('d-block')){$('#manual_approval_in_progress').removeClass('d-none').addClass('d-block');}else{$('#manual_approval_in_progress').removeClass('d-block').addClass('d-none');}
if(allowEditPoa){$('#stepTitle').html(headerAddress);if(!$('#iconStepTitle').hasClass('icon-map-point')){$('#iconStepTitle').removeClass('icon-identity-confirmation').addClass('icon-map-point');}
if(!$('.stepper-item.poi').hasClass('completed')){$('.stepper-item.poi').removeClass('active').addClass('completed');if($('.icon-clock.yellow').length>0){$('.icon-clock.yellow').removeClass('icon-clock yellow').addClass('icon-tick green');}else{$('.stepper-item.poi .step-name.step-title').html($('.stepper-item.poi .step-name.step-title').html()
+'<span class="icon icon-tick green ml-lg-2 ml-1"></span>');}}
$('.stepper-item.poa').addClass('active');if($('.popover-username span').hasClass('red')){$('.popover-username span').removeClass('red');}
$('.identity-heading').addClass('hide');$('.identity-data .form-control').each(function(){$(this).attr('readonly',true);$(this).attr('disabled','disabled');});}
if(allowEditPoi&&!$('#iconStepTitle').hasClass('icon-identity-confirmation')){$('#stepTitle').html(headerId);$('#iconStepTitle').removeClass('icon-map-point').addClass('icon-identity-confirmation');if($('.stepper-item.poi').hasClass('completed')){$('.stepper-item.poi').removeClass('completed').addClass('active');$('.stepper-item.poi .step-name').find('span').remove();}
$('.stepper-item.poa .step-name.step-title').find('span').remove();$('.stepper-item.poa').removeClass('active').removeClass('completed');$('.address-heading').addClass('hide');$('.address-data .form-control').not('[name=country]').each(function(){$(this).attr('readonly',true);$(this).attr('disabled','disabled');});let poiType=files&&files['POI']&&files['POI']['type']?parseInt(files['POI']['type']):null;setTypes(step,poiType);$('.address-heading').addClass('hide');$('.address-data .form-control').not('[name=country]').each(function(){$(this).attr('readonly',true);$(this).attr('disabled','disabled');});if(!$('.popover-username span').hasClass('red')){$('.popover-username span').addClass('red');}}
$('[name=step]').val(allowEditPoa?'POR':'POI');}
if(allowEditPoa&&showAddressFields){$('.address-heading').removeClass('hide');$('.address-data .form-control').not('[name=country]').each(function(){$(this).removeAttr('disabled').removeAttr('readonly');});}
if(allowEditPoi&&showIdentityFields){$('.identity-heading').removeClass('hide');$('.identity-data .form-control').each(function(){$(this).removeAttr('disabled').removeAttr('readonly');});}}
function updateDataForPOR(files){let newId='';if(files.front!==undefined&&files.front.id!==undefined){newId=files.front.id;}else if(files.back!==undefined&&files.back.id!==undefined){newId=files.back.id;}
if(newId){refreshIntervalId=setInterval(update,10000,newId);}
$('.alert.kyc.d-block').removeClass('d-block').addClass('d-none');$('#upload_por_status_pending').removeClass('d-none').addClass('d-block');$('.stepper-item.poi').removeClass('active').addClass('completed');if($('.icon-clock.yellow').length>0){$('.icon-clock.yellow').removeClass('icon-clock yellow').addClass('icon-tick green');}else{$('.stepper-item.poi .step-name.text-center').html($('.stepper-item.poi .step-name.text-center').html()
+'<span class="icon icon-tick green ml-lg-2 ml-1"></span>');}
$('.stepper-item.poa').addClass('active');$('.popover-username').attr('data-content',poa_not_uploaded);$('#stepTitle').html(headerAddress);if(!$('#iconStepTitle').hasClass('icon-map-point')){$('#iconStepTitle').removeClass('icon-identity-confirmation').addClass('icon-map-point');}
$('.stepper-item.poa .step-name.text-center').html($('.stepper-item.poa .step-name.text-center').html()
+'<span class="icon icon-clock yellow ml-lg-2 ml-1"></span>');$('#type').val(files['type']).attr('disabled',true).change();if(files!=undefined){$('.drop-zone_prompt, .card-footer, .documents-info').hide();updateThumb(files,'front');updateThumb(files,'back');$('.spinner-loader').removeClass('d-none').addClass('d-flex');$('.drop-zone').addClass('preview');$('.card.profile').hide();}}
$('#firstSidePreview,#otherSidePreview').on('load',function(){$(this).parent().find('.spinner-loader').each(function(){$(this).removeClass('d-flex').addClass('d-none');});}).on('error',function(){$(this).parent().find('.spinner-loader').each(function(){$(this).removeClass('d-flex').addClass('d-none');});});$(document).ready(function(){if(typeof(completeProfile)!=='undefined'){return;}
if(typeof(error)!=='undefined'&&error){$('#type').val('');}
let codes=[],responseFrom='';if(typeof(filesInfo)!=='undefined'&&filesInfo[nextStep]!=undefined&&filesInfo[nextStep].declined_codes!=undefined){codes=filesInfo[nextStep].declined_codes;responseFrom=filesInfo[nextStep].responseFrom;}
if(typeof(updateStatus)!=='undefined'&&updateStatus&&fileId!==null&&(responseFrom!=='crm')){refreshIntervalId=setInterval(update,10000,fileId,checkOnlyCrmResponse);}else{refreshIntervalId=setInterval(update,10000,'all');}
if(typeof(filesInfo)!=='undefined'){changeData(filesInfo,nextStep,codes,false,manualVerificationInProgress);}
if(nextStep=='POI'||!showAddressFields||(nextStep=='POR'&&!allowEditPoa)){$('.address-data .form-control').not('[name=country]').each(function(){$(this).attr('readonly',true);});}
if(nextStep=='POR'||!showIdentityFields||(nextStep=='POI'&&!allowEditPoi)){$('.identity-data .form-control').each(function(){$(this).attr('readonly',true);});}
setFileEvents($('.drop-zone_input'));document.querySelectorAll(".drop-zone").forEach((dropZoneElement)=>{let inputElement=$(dropZoneElement).find(".drop-zone_input")[0];dropZoneElement.addEventListener("click",(e)=>{if($(dropZoneElement).hasClass('preview')){return;}
var fileElement=e.target;if(fileElement.value!=""){clone[fileElement.id]=$(fileElement).clone();}
$('#'+inputElement.id).click();});dropZoneElement.addEventListener("dragover",(e)=>{if($(dropZoneElement).hasClass('preview')){return;}
e.preventDefault();dropZoneElement.classList.add("drop-zone-over");});["dragleave","dragend"].forEach((type)=>{dropZoneElement.addEventListener(type,(e)=>{if($(dropZoneElement).hasClass('preview')){return;}
dropZoneElement.classList.remove("drop-zone-over");});});dropZoneElement.addEventListener("drop",(e)=>{if($(dropZoneElement).hasClass('preview')){return;}
e.preventDefault();if(e.dataTransfer.files.length){$('#'+inputElement.id)[0].files=e.dataTransfer.files;updateThumbnail(dropZoneElement,e.dataTransfer.files[0]);}
$('#'+inputElement.id).change();dropZoneElement.classList.remove("drop-zone-over");});});$('.drop-zone').on('hover',function(){if($('.drop-zone').hasClass('preview')||$(this).find('input[type=file]').val()===''){return;}
if(fileUploaded){fileUploaded=false;return;}
$(this).parent().find('.hover-menu').show();$(this).addClass('image-blur');});$('.hover-menu').on('mouseleave',function(){$('.hover-menu').hide();$('.drop-zone').removeClass('image-blur');});$('#open-other, #open-first').on('click',function(){let file=$(this).parent().parent().find('.drop-zone_input')[0].files[0];if(file.type=='application/pdf'){$('.document-preview').hide();$('.pdf-document-preview').show();}else{$('.document-preview').show().attr("src",URL.createObjectURL(file));$('.pdf-document-preview').hide();}
$('#modal_preview').modal('show');});$('.icon-change').on('click',function(){$(this).parent().parent().find('.drop-zone_prompt').click();hideCanvas($(this).parent().parent().find('.drop-zone_pdf'));});$('#remove-other, #remove-first').on('click',function(){let id=$(this).parent().parent().find('.drop-zone_input').attr('id');clone=Object.keys(clone).filter(key=>key!==id).reduce((obj,key)=>{obj[key]=clone[key];return obj;},{});$(this).parent().parent().find('.drop-zone_input').val(null).change();$('.hover-menu').mouseleave();});$('form').submit(function(e){disableSubmitButton();if($('#postcode').val().length>10||$('form').find('is-invalid').length>0){e.preventDefault();}
$(this).find("button[type='submit']").prop('disabled',true);});$('.bill-menu .icon-increase').on('click',function(){$('.document-preview').show().attr('src',$('.bill-preview')[0].src);$('.pdf-document-preview').hide();$('#modal_preview').modal('show');});});$('select#type').on('change',function(){var selected=$(this).val(),step=$('[name=step]').val();if((step==='POI'&&documentsWith2SidesPOI!=undefined&&$.inArray(parseInt(selected),documentsWith2SidesPOI)!=-1)||(step==='POR'&&documentsWith2SidesPOR!=undefined&&$.inArray(parseInt(selected),documentsWith2SidesPOR)!=-1)){$('#dropZone-back').show();showOtherSide=true;}else{$('#dropZone-back').hide();showOtherSide=false;}
if(selected!==''){$('.drop-zone_preview').hide();$('.drop-zone_prompt').show();$('.drop-zone').removeClass('drag-preview');}else{$('#submit_btn').addClass('disabled').disabled=true;$('.drop-zone_prompt').hide();$('.drop-zone_preview').show();$('.drop-zone').addClass('drag-preview');}
$('#submit_btn').addClass('disabled').disabled=true;$('#submit_btn').prop('title',$('#submit_btn').hasClass('disabled')?disabledTitle:'');clearFiles();$('#extensionError').hide();});})(jQuery);