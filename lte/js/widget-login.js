(function($){function WidgetLogin(params){WidgetForm.apply(this,arguments);this.ajax=true;this.setup();}
WidgetLogin.prototype=$.extend(new WidgetForm(),{url:Site.domain+'/json/login.json',ajax:true,setup:function(){var validation=this.validation=new Form(),node=this.node;validation.add(node.find('#fieldLogin'),{'validate':Validation.isEmail}).add(node.find('#fieldPassword'),{'validate':Validation.notEmpty});this.setupFieldHighlighting(validation);},validate:function(values){return this.validation.validate();},show:function(){WidgetForm.prototype.show.apply(this,arguments);this.node.find('div.error-message').hide();this.setInputError('fieldLogin',false);this.setInputError('fieldPassword',false);$('#fieldLogin').val('');$('#fieldPassword').val('');},gtm:function(){window.dataLayer=window.dataLayer||[];},gtmDataLayerPush:function(){window.dataLayer.push(this.gtmDataLayer);},gtmDataLayer:{"event":'CE login',"event_properties":{},"user_properties":{"user_id":''},"user":{"user_id":''},"ga_event":{"category":"Authentication"}},_handleFormSubmit:function(){if(this.sending)
return false;var values=this.form.serializeObject(),data;$('.portal-home-password').removeClass('is-invalid');$('.portal-home-email').removeClass('is-invalid');if(data=this.validate(values)){if(this.ajax){if(Site.context=='ia'){this.loginObj={email:values.login,brand:Site.soliticsBrand,popuptoken:Site.soliticsPopupToken}}
var method='json';var func=$.post;if(Site.ssl&&document.location.protocol!='https:'){method=null;func=$.cdrPost;}
if(typeof data!='object')
data=values;this.sending=true;this.gtm();func(this.url,values,$.proxy(this._onSubmitResponse,this),method);}else{this.gtm();this.node.find('input[type="submit"],button[type="submit"]').attr('disabled','disabled');return true;}}
return false;},_onSubmitResponse:function(response){this.sending=false;if(Site.context=='ia'&&response.timestamp){this.loginObj.memberId=response.timestamp
$solitics.loginSuccess(this.loginObj)
this.gtmDataLayer.user_properties.user_id=String(response.timestamp);this.gtmDataLayer.user.user_id=String(response.timestamp);this.gtmDataLayerPush();}
if(response===true||response.success==1){if(this.success()){this.node.find('fieldset').slideUp('fast');this.node.find('div.feedback-message').slideDown('fast');}}else{this.error(response);if(response.error){for(var input_id in response.error){this.node.find('div.error-'+input_id+'-'+response.error[input_id]).slideDown('fast');this.setInputError(input_id,true);}}else{this.node.find('div.error').not('.select,.file').eq(0).slideDown('fast');}}
this.off=0;},success:function(){$('#login-error-message').hide();document.location.reload();return false;},error:function(response){if(response.error&&response.error=='wrongDomain'){window.location=response.host+response.url;}else if(response.error&&response.error=='wrongPath'){var d=new Date();d.setTime(d.getTime()+(365*24*60*60*1000));var expires="expires="+d.toUTCString();document.cookie="IFSIDPERSIST"+"=1;path="+response.localPath+";expires="+expires;this.moveSessionCookie(response.context,response.localPath,response.targetPath);document.cookie="IFSIDPERSIST"+"=1;path="+response.targetPath+";expires="+expires;window.location=response.targetPath+'client-portal';}else if(response.error&&response.error=='reditectToPage'){window.location=response.url;}else if(response.error&&response.error=='security'){location.reload();}else{$('.portal-home-password').addClass('is-invalid').trigger('classChangeTrigger');$('.portal-home-email').addClass('is-invalid').trigger('classChangeTrigger');$('#login-error-message').show();}},moveSessionCookie:function(currentContext,localPath,targetPath){var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var cookie=cookies[i];var p=cookie.indexOf("=");var name=cookie.substring(0,p).replace(/\s/g,'');var value=cookie.substring(p+1);var regexp=new RegExp('^'+currentContext+'-');if(name=='IFSID'&&value.match(regexp)!==null){document.cookie=name+"=;path="+localPath+";expires=Thu, 01 Jan 1970 00:00:00 GMT";document.cookie=name+"="+value+";path="+targetPath;}}
return cookies;}});window.loginForm=new WidgetLogin({'html':$('#headerLoginForm')});})(jQuery);