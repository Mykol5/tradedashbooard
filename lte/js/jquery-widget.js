(function($,win){var Widget=win.Widget=function(params){if(!params)return this;this.node=params.html;this.ajax=params.ajax===false?false:true;if(params.html){params.html.find('a.close, a.cancel').click(function(){if(typeof Lightbox!=='undefined'&&Lightbox){Lightbox.hide();return false;}});}};Widget.prototype={ajax:true,node:null,show:function(){},hide:function(){}};win.WidgetForm=function(params){if(!params)return;Widget.apply(this,arguments);this.countries_inputs=[];this.default_values={};this.form=this.node.find('form');if(!this.form.length)this.form=this.node.filter('form');this.form.bind('submit',$.proxy(this._handleFormSubmit,this));var inputs=this.form.find('input,textarea,select'),name;for(var i=0,ii=inputs.length;i<ii;i++){name=inputs.eq(i).attr('name');if(name){this.default_values[name]=inputs.eq(i).val();}}
this.chained=[];this.ajax=this.form.hasClass('styled-ajax');this.url=this.url||this.form.attr('action')||params.url||document.location.pathname;};WidgetForm.prototype=$.extend(new Widget(),{form:null,countries_url:Site.domain+'/json/countries.json',lead_url:Site.domain+'/json/drupal-call-back.json',leadSent:false,showOverlay:function(){},validData:false,countries:null,countries_inputs:[],sending:false,default_values:{},chained:[],loadCountryList:function(callback){if(typeof Site!=='undefined'&&Site.hasOwnProperty('language')){locale=Site.language;}else{locale='en';}
$.get(this.countries_url,{'locale':locale},$.proxy(function(data){WidgetForm.countries=data;this._populateCountryInputs(callback);},this),'json');},populateCountryInput:function(input,callback){if(!this.ajax){}else{this.countries_inputs.push(input);if(WidgetForm.countries){this._populateCountryInputs(callback);}else{this.loadCountryList(callback);}}},_populateCountryInputs:function(callback){var inputs=this.countries_inputs,countries=WidgetForm.countries,html='';for(var id in countries){if(countries.hasOwnProperty(id)){html+='<option value="'+id+'">'+$.escape(countries[id])+'</option>';}}
for(var i=0,ii=inputs.length;i<ii;i++){inputs[i].append(html);var $defCountry=$(inputs[i].get(0)).attr('data-defaultcountry');if($defCountry){$(inputs[i].get(0)).val($defCountry);}}
this.countries_inputs=[];if(typeof callback=='function')callback(inputs);},validate:function(values){return values;},gtm:function(){},onFormNotValid:function(){},_handleFormSubmit:function(){if(this.sending)return false;var values=this.form.serializeObject(),data;this.node.find('div.error').not('.select,.file').slideUp('fast');this.node.find('div.error-message').slideUp('fast');this.node.find('label,input, textarea, div.select').removeClass('error');if(data=this.validate(values)){if(typeof reportButtonClickOnFormValid!=='undefined'){reportButtonClickOnFormValid(this.node.find('input[type="submit"],button[type="submit"]'))}
this.validData=values;this.gtm();if(this.ajax){if(typeof data!='object')data=values;this.sending=true;$.post(this.url,values,$.proxy(this._onSubmitResponse,this),'json');}else{this.node.find('input[type="submit"],button[type="submit"]').attr('disabled','disabled');return true;}}
return false;},_onSubmitResponse:function(response){this.sending=false;if(response===true||response.success==1){if(this.success()){this.node.find('fieldset').slideUp('fast');this.node.find('div.feedback-message').slideDown('fast');}}else{this.error(response);if(response.error){for(var input_id in response.error){this.node.find('div.error-'+input_id+'-'+response.error[input_id]).slideDown('fast');this.setInputError(input_id,true);}}else{this.node.find('div.error').not('.select,.file').eq(0).slideDown('fast');}}
this.off=0;},setupFieldHighlighting:function(validation){$(validation).bind('validate:all',$.proxy(function(event,data){var errors=data.errors,inputs=validation.inputs;for(var i in inputs){if(i in errors){this.setInputError(inputs[i].node,true);}else{this.setInputError(inputs[i].node,false);}}},this));$(validation).bind('validate:field',$.proxy(function(event,data){var id=data.id,error=data.error,input=validation.inputs[id].node;this.setInputError(input,error);},this));},setInputError:function(field,is_error){var input=typeof field=='string'?this.node.find('#'+field):field;if(!input.length&&typeof field=='string')input=this.node.find('*[name="'+field+'"]');var prev=null;var label=input.siblings('label');if(input.is('select')){var dropdown=input.data('dropdown');if(dropdown){input=dropdown.custom;}}
if(input.is(':file')){var file=input.data('file');if(file){input=file.custom;}}
if(is_error){input.addClass('is-invalid');}else{input.removeClass('is-invalid');}},show:function(){var inputs=this.form.find('input,textarea,select'),name;for(var i=0,ii=inputs.length;i<ii;i++){name=inputs.eq(i).attr('name');if(name&&name in this.default_values){inputs.eq(i).val(this.default_values[name]);inputs.eq(i).trigger('change');}else if(name){inputs.eq(i).val('');inputs.eq(i).trigger('change');}}
this.node.find('div.feedback-message').hide();this.node.find('div.error-message').hide();this.node.find('div.error').not('.select,.file').hide();this.node.find('fieldset').show();this.node.find('button[type="submit"]').removeAttr('disabled');},chain:function(inputs,callback){if(!$.isArray(inputs))inputs=[inputs];var inp=this._chainGetInputs(inputs);params={'inputs':inputs,'inp':inp,'callback':callback},fn=$.proxy(this._chainChange,this);inp.bind('change',params,fn).bind('chain',params,fn);this.chained.push(inp);},initChain:function(){var chained=this.chained;for(var i=0,ii=chained.length;i<ii;i++){chained[i].trigger('chain');}
if(this.form.hasClass('locked')){this.lockForm();}},lockForm:function(){this.form.find('input, textarea').not(':disabled').attr('disabled',1).data('locked',true);this.form.find('select').not(':disabled').attr('disabled',1).data('locked',true).each(function(){var dropdown=$(this).data('dropdown');if(dropdown){dropdown.disable();}});this.form.find('span.button-normal').hide();this.form.find(':submit').hide();},unlockForm:function(){this.form.find('input,select').each(function(){if($(this).data('locked')){$(this).attr('disabled',false)
var dropdown=$(this).data('dropdown');if(dropdown){$(this).enable();}}});},_chainChange:function(event){var inp=event.data.inp,inputs=event.data.inputs,callback=event.data.callback;var values=this._chainGetValues(inputs);var ret=callback.apply(inp,values),show=ret&&ret.show?ret.show:null,hide=ret&&ret.hide?ret.hide:null;if(show){show=this._chainGetInputs(show);for(var i=0,ii=show.length;i<ii;i++){var item=show.eq(i),dropdown;if(item.is('input,select,textarea')){item.parent().removeClass('collapse');item.closest('.form-group').removeClass('collapse');var formLocked=this.form.hasClass('locked');if(!formLocked){item.removeAttr('disabled');dropdown=item.data('dropdown');if(dropdown){dropdown.enable();}}
item.trigger('chain');}else{item.removeClass('collapse');}}}
if(hide){hide=this._chainGetInputs(hide);for(var i=0,ii=hide.length;i<ii;i++){var item=hide.eq(i);if(item.is('input,select,textarea')){item.attr('disabled','disabled').parent().addClass('collapse');item.closest('.form-group').addClass('collapse');dropdown=item.data('dropdown');if(dropdown){dropdown.disable();}
item.trigger('chain');}else{item.addClass('collapse');}}}},_chainGetInputs:function(inputs){var inp=$(),validation=this.validation;for(var i=0,ii=inputs.length;i<ii;i++){if(validation&&inputs[i]in validation.inputs){inp=inp.add(validation.inputs[inputs[i]].node)}else{inp=inp.add('#'+inputs[i]);}}
return inp;},_chainGetValues:function(inputs){var values=[],validation=this.validation;for(var i=0,ii=inputs.length;i<ii;i++){values[i]=null;var inp=validation&&inputs[i]in validation.inputs?validation.inputs[inputs[i]].node:null;if(inp&&!inp.attr('disabled')){values[i]=inp.val();}}
return values;},getExchangeRate:function(currencyFrom,currencyTo,amount,idName,type='buy'){if(currencyFrom==currencyTo){$("#"+idName).val(amount);return;}
var erUrl='https://'+window.location.hostname+'/json/er.json';var newAmount=0;$.ajax({url:erUrl,async:false,cache:false,type:"POST",data:{'currency_from':currencyFrom,'currency_to':currencyTo,type:type},success:function(data){if(data!=''){newAmount=amount*data;newAmount=Math.round(newAmount);}
$("#"+idName).val(newAmount);}});},success:function(){return true;},error:function(){}});WidgetForm.countries=null;})(jQuery,window);